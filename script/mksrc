#!/bin/bash
usage()
{
	echo "mksrc usage:"
	echo "mksrc [options] <dirname> <objname>"
	echo "      dirname: the storage path of C source and header file"
	echo "      objname: the file name of C source and header file"
	echo "options:"
	echo "c : to make C source file"
	echo "h : to make C header file"
	echo "t : to make C unit test file"
	echo "s : to make command file"
	echo "d : use macro config flag"

}

parse_opt()
{
	local opt=$1
	if [[ $opt != "-"*  ]]
	then
		OFLAG=false
		CFLAG=true
		HFLAG=true
		return
	fi
	if [[ $opt == *"c"*  ]]
	then
		CFLAG=true
	fi
	if [[ $opt == *"h"*  ]]
	then
		HFLAG=true
	fi
	if [[ $opt == *"t"*  ]]
	then
		TFLAG=true
	fi
	if [[ $opt == *"s"*  ]]
	then
		SFLAG=true
	fi
	if [[ $opt == *"d"*  ]]
	then
		DFLAG=true
	fi
	echo "DFLAG="$CFLAG
	echo "HFLAG="$HFLAG
	echo "TFLAG="$TFLAG
	echo "SFLAG="$SFLAG
	echo "DFLAG="$DFLAG
}



gen_macro_head()
{
	if [ $DFLAG != "true" ]
	then
		return
	fi
	echo "gen_macro_head "$1
	local filename=$1
	echo ${filename^^}
	defstr=`echo ${filename^^}`
	defstr=$defstr"_SUPPORT"
	#echo $defstr
	PREINFO=""
	PREINFO+="#if "$defstr"\r\n"
	#echo -e "${PREINFO}"
	#echo "gen_macro_head exit"
}

gen_macro_tail()
{
	if [ $DFLAG != "true"  ]
	then
		return
	fi
	echo "gen_macro_tail "$1
	local filename=$1
	echo "filename:"${filename}
	defstr=`echo ${filename^^}`
	defstr=$defstr"_SUPPORT"
	#echo $defstr
	PREINFO=""
	PREINFO+="#endif // #if "$defstr"\r\n"
	#echo -e "${PREINFO}"
	#echo "gen_macro_tail exit"
}

gen_file_head()
{
	local filename=$1
	local defstr=`echo ${FILENAME^^}`
	defstr=$defstr"_H__"
	#echo $defstr
	PREINFO=""
	PREINFO+="/****************************************Copyright (c)**************************************************\r\n"
	PREINFO+="**                                       God's harbor\r\n"
	PREINFO+="**\r\n"
	PREINFO+="**                                       yzfcer@163.com\r\n"
	PREINFO+="**\r\n"
	PREINFO+="**--------------File infomation-------------------------------------------------------------------------\r\n"
	PREINFO+="** FileName    : "${filename}"\r\n"
	PREINFO+="** Author      : "${AUTHOR}"\r\n"
	PREINFO+="** Last Date   : "${DATETIME}"\r\n"
	PREINFO+="** Description : \r\n"
	PREINFO+="**              \r\n"
	PREINFO+="**--------------History---------------------------------------------------------------------------------\r\n"
	PREINFO+="** Author      : "${AUTHOR}"\r\n"
	PREINFO+="** Version     : v1.0\r\n"
	PREINFO+="** Date        : "${DATETIME}"\r\n"
	PREINFO+="** Description : First version\r\n"
	PREINFO+="**\r\n"
	PREINFO+="**--------------Cureent version-------------------------------------------------------------------------\r\n"
	PREINFO+="** Modify      : "${AUTHOR}"\r\n"
	PREINFO+="** Date        : "${DATETIME}"\r\n"
	PREINFO+="** Description : \r\n"
	PREINFO+="**\r\n"
	PREINFO+="**------------------------------------------------------------------------------------------------------\r\n"
	PREINFO+="*******************************************************************************************************/\r\n"
	if [[ $filename == *".h" ]]
	then
		PREINFO+="#ifndef "$defstr"\r\n"
		PREINFO+="#define "$defstr"\r\n"
		PREINFO+="#include \"wind_config.h\"\r\n"
		PREINFO+="#include \"wind_type.h\"\r\n"
	elif [[ $filename == "wind_"*".c" ]]
	then
		PREINFO+="#include \""${FILENAME}".h\"\r\n"
		PREINFO+="#include \"wind_obj.h\"\r\n"
	fi
	PREINFO+="#ifdef __cplusplus\r\n"
	PREINFO+="extern \"C\" {\r\n"
	PREINFO+="#endif // #ifdef __cplusplus\r\n"

	#echo -e "${PREINFO}"

}




gen_file_tail()
{
	local filename=$1
	local defstr=`echo ${FILENAME^^}`
	defstr=$defstr"_H__"
	#echo $defstr
	PREINFO=""
	PREINFO+="#ifdef __cplusplus\r\n"
	PREINFO+="}\r\n"
	PREINFO+="#endif // #ifdef __cplusplus\r\n"
	if [[ $filename == *".h" ]]
	then
		PREINFO+="#endif //#ifndef "$defstr"\r\n"
	fi
	#echo -e "${PREINFO}"
}

# $1 destinational file with path
# $2 destinational file 
# $3 file suffix
mkfile()
{
	local destfile=${1}.${3}
	local filename=$2
	local suffix=$3
	if [ -f ${destfile} ]
	then
		#rm -f ${destfile}
		echo ${destfile}" has been exist"
		return
	fi
	echo "filename="${filename}
	echo "make file:"${destfile}
	touch ${destfile}
	gen_file_head ${filename}.${suffix}
	echo -e "${PREINFO}" >> ${destfile}
	echo "1 filename="${filename}
	gen_macro_head ${filename}
	echo -e "${PREINFO}" >> ${destfile}
	
	
	echo "2 filename="${filename}
	gen_macro_tail ${filename}
	echo -e "${PREINFO}" >> ${destfile}
	gen_file_tail ${filename}.${suffix}
	echo -e "${PREINFO}" >> ${destfile}
	sed -i 's///g' ${destfile}

}



CUR_PATH=$(cd $(dirname $0); pwd)
STORPATH=$1
OBJNAME=$2
FILENAME=wind_$2
#DATETIME=`date + "%Y/%m/%D %H:%M:%S"`
DATETIME=`date +%Y-%m-%d`
AUTHOR="Jason Zhou"
PATHFILE=${STORPATH}/${FILENAME}
PREINFO=""
OFLAG=true
CFLAG=false
HFLAG=false
TFLAG=false
SFLAG=false
DFLAG=false

if [ $# -lt 2 ]
then
	usage
	exit 0
fi
parse_opt $@
if [ $OFLAG == "true"  ]
then
	STORPATH=$2
	OBJNAME=$3
	FILENAME=wind_$3
	PATHFILE=${STORPATH}/${FILENAME}
fi



if [ $HFLAG == "true" ]
then
	mkfile ${PATHFILE} ${FILENAME} h
fi

if [ $CFLAG == "true" ]
then
	mkfile ${PATHFILE} ${FILENAME} c
fi


