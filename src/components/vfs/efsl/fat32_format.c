#include "wind_type.h"
#include "efs.h"
#include "interface.h"
#include "wind_debug.h"
#include "wind_string.h"
static w_uint8_t fat32_root[512] = {
	0xEB,0x58,0x90, 'w', 'i', 'n', 'd', '-', 'o', 's', '0',0x00,0x02,0x08,0x26,0x00,
	0x02,0x00,0x00,0x00,0x00,0xF8,0x00,0x00,0x3F,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,
	0x01,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x29,0x96,0x02,0x8F,0x54,0x4E,0x4F,0x20,0x4E,0x41,0x4D,0x45,0x20,0x20,
	0x20,0x20,0x46,0x41,0x54,0x33,0x32,0x20,0x20,0x20,0x33,0xC9,0x8E,0xD1,0xBC,0xF4,
	0x7B,0x8E,0xC1,0x8E,0xD9,0xBD,0x00,0x7C,0x88,0x4E,0x02,0x8A,0x56,0x40,0xB4,0x08,
	0xCD,0x13,0x73,0x05,0xB9,0xFF,0xFF,0x8A,0xF1,0x66,0x0F,0xB6,0xC6,0x40,0x66,0x0F,
	0xB6,0xD1,0x80,0xE2,0x3F,0xF7,0xE2,0x86,0xCD,0xC0,0xED,0x06,0x41,0x66,0x0F,0xB7,
	0xC9,0x66,0xF7,0xE1,0x66,0x89,0x46,0xF8,0x83,0x7E,0x16,0x00,0x75,0x38,0x83,0x7E,
	0x2A,0x00,0x77,0x32,0x66,0x8B,0x46,0x1C,0x66,0x83,0xC0,0x0C,0xBB,0x00,0x80,0xB9,
	0x01,0x00,0xE8,0x2B,0x00,0xE9,0x48,0x03,0xA0,0xFA,0x7D,0xB4,0x7D,0x8B,0xF0,0xAC,
	0x84,0xC0,0x74,0x17,0x3C,0xFF,0x74,0x09,0xB4,0x0E,0xBB,0x07,0x00,0xCD,0x10,0xEB,
	0xEE,0xA0,0xFB,0x7D,0xEB,0xE5,0xA0,0xF9,0x7D,0xEB,0xE0,0x98,0xCD,0x16,0xCD,0x19,
	0x66,0x60,0x66,0x3B,0x46,0xF8,0x0F,0x82,0x4A,0x00,0x66,0x6A,0x00,0x66,0x50,0x06,
	0x53,0x66,0x68,0x10,0x00,0x01,0x00,0x80,0x7E,0x02,0x00,0x0F,0x85,0x20,0x00,0xB4,
	0x41,0xBB,0xAA,0x55,0x8A,0x56,0x40,0xCD,0x13,0x0F,0x82,0x1C,0x00,0x81,0xFB,0x55,
	0xAA,0x0F,0x85,0x14,0x00,0xF6,0xC1,0x01,0x0F,0x84,0x0D,0x00,0xFE,0x46,0x02,0xB4,
	0x42,0x8A,0x56,0x40,0x8B,0xF4,0xCD,0x13,0xB0,0xF9,0x66,0x58,0x66,0x58,0x66,0x58,
	0x66,0x58,0xEB,0x2A,0x66,0x33,0xD2,0x66,0x0F,0xB7,0x4E,0x18,0x66,0xF7,0xF1,0xFE,
	0xC2,0x8A,0xCA,0x66,0x8B,0xD0,0x66,0xC1,0xEA,0x10,0xF7,0x76,0x1A,0x86,0xD6,0x8A,
	0x56,0x40,0x8A,0xE8,0xC0,0xE4,0x06,0x0A,0xCC,0xB8,0x01,0x02,0xCD,0x13,0x66,0x61,
	0x0F,0x82,0x54,0xFF,0x81,0xC3,0x00,0x02,0x66,0x40,0x49,0x0F,0x85,0x71,0xFF,0xC3,
	0x4E,0x54,0x4C,0x44,0x52,0x20,0x20,0x20,0x20,0x20,0x20,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0D,0x0A,0x52,0x65, 
	0x6D,0x6F,0x76,0x65,0x20,0x64,0x69,0x73,0x6B,0x73,0x20,0x6F,0x72,0x20,0x6F,0x74,
	0x68,0x65,0x72,0x20,0x6D,0x65,0x64,0x69,0x61,0x2E,0xFF,0x0D,0x0A,0x44,0x69,0x73,
	0x6B,0x20,0x65,0x72,0x72,0x6F,0x72,0xFF,0x0D,0x0A,0x50,0x72,0x65,0x73,0x73,0x20,
	0x61,0x6E,0x79,0x20,0x6B,0x65,0x79,0x20,0x74,0x6F,0x20,0x72,0x65,0x73,0x74,0x61,
	0x72,0x74,0x0D,0x0A,0x00,0x00,0x00,0x00,0x00,0xAC,0xCB,0xD8,0x00,0x00,0x55,0xAA
};
static w_uint8_t FAT32_Buffer[512];

w_err_t fat32_format(EmbeddedFileSystem *fs,char *blkname)
{
	w_uint32_t sec_tot,sec_fat,sec_reserve;

    if(!if_initInterface(&fs->myCard,blkname))
    {
        wind_error("hwif init failed.");
        return W_ERR_FAIL;
    }
	sec_tot = fs->myCard.sectorCount;
	if(sec_tot)
	{	
		sec_fat = sec_tot/1026+1;
		sec_reserve = 0x26;
		fat32_root[15] = (w_uint8_t)(((w_uint16_t)sec_reserve&0xFF00)>>8); 
		fat32_root[14] = (w_uint8_t)((w_uint16_t)sec_reserve&0x00FF); 
		fat32_root[35] = (w_uint8_t)((sec_tot&0xFF000000)>>24); 
		fat32_root[34] = (w_uint8_t)((sec_tot&0x00FF0000)>>16);  
		fat32_root[33] = (w_uint8_t)((sec_tot&0x0000FF00)>>8); 
		fat32_root[32] = (w_uint8_t)((sec_tot&0x000000FF)); 		 //总扇区数
		fat32_root[39] = (w_uint8_t)((sec_fat&0xFF000000)>>24); 
		fat32_root[38] = (w_uint8_t)((sec_fat&0x00FF0000)>>16); 
		fat32_root[37] = (w_uint8_t)((sec_fat&0x0000FF00)>>8); 
		fat32_root[36] = (w_uint8_t)((sec_fat&0x000000FF)); 		     //FAT表扇区数
		if_writeBuf(&fs->myCard,0,fat32_root);
		if_writeBuf(&fs->myCard,0x06,fat32_root);

        if_erase(&fs->myCard,sec_reserve,sec_reserve+(sec_fat*2)+8);
        wind_memset(FAT32_Buffer,0,512);
		FAT32_Buffer[0]=0xF8;
        wind_memset(&FAT32_Buffer[1],0xFF,10);
		FAT32_Buffer[3]=0x0F;
		FAT32_Buffer[11]=0x0F;
		if_writeBuf(&fs->myCard,sec_reserve,FAT32_Buffer);
		if_writeBuf(&fs->myCard,sec_reserve+sec_fat,FAT32_Buffer);
        return W_ERR_OK;
	}
	else
	{
		return W_ERR_FAIL;
	}
	return 0;
}
